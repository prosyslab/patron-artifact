#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>

typedef unsigned char BYTE;
typedef unsigned int UINT32;
typedef unsigned short UINT16;
typedef int BOOL;
#define FALSE 0
#define TRUE 1

struct NSC_CONTEXT_PRIV
{
  BYTE* PlaneBuffers[4];
  UINT32 PlaneBuffersLength;
};

typedef struct NSC_CONTEXT_PRIV NSC_CONTEXT_PRIV;

struct S_NSC_CONTEXT
{
	UINT32 OrgByteCount[4];
	UINT32 format;
	UINT16 width;
	UINT16 height;
	BYTE* BitmapData;
	UINT32 BitmapDataLength;

	BYTE* Planes;
	size_t PlanesSize;
	UINT32 PlaneByteCount[4];
	UINT32 ColorLossLevel;
	UINT32 ChromaSubsamplingLevel;
	BOOL DynamicColorFidelity;
  NSC_CONTEXT_PRIV* priv;

	/* color palette allocated by the application */
	const BYTE* palette;
};



typedef struct S_NSC_CONTEXT NSC_CONTEXT;

int planeSize = 0;

void init_nsc_context(NSC_CONTEXT* context, char * filename)
{
  FILE *f = fopen(filename, "r");
  fread(&context->format, sizeof(UINT32), 1, f);
  fread(&context->width, sizeof(UINT16), 1, f);
  fread(&context->height, sizeof(UINT16), 1, f);
  fread(&context->OrgByteCount, sizeof(UINT32), 4, f);
  fread(&context->PlaneByteCount, sizeof(UINT32), 4, f);
  fread(&context->ColorLossLevel, sizeof(UINT32), 1, f);
  fread(&context->ChromaSubsamplingLevel, sizeof(UINT32), 1, f);
  fread(&context->DynamicColorFidelity, sizeof(BOOL), 1, f);
  fread(&context->PlanesSize, sizeof(size_t), 1, f);
  context->Planes = (BYTE*)malloc(context->PlanesSize);
  fread(context->Planes, sizeof(BYTE), context->PlanesSize, f);
  fread(&planeSize, sizeof(int), 1, f);
  context->PlanesSize = 4 * planeSize;
  context->priv = (NSC_CONTEXT_PRIV*)malloc(sizeof(NSC_CONTEXT_PRIV));
  for (size_t i = 0; i < 4; i++)
  {
    context->priv->PlaneBuffers[i] = (BYTE*)malloc(planeSize);
  }
  context->priv->PlaneBuffersLength = planeSize;
  fclose(f);
}

BOOL nsc_rle_decompress_data(NSC_CONTEXT* context)
{
	if (!context)
		return FALSE;

	const BYTE* rle = context->Planes;
	size_t rleSize = context->PlanesSize;

	for (size_t i = 0; i < 4; i++)
	{
		const UINT32 originalSize = context->OrgByteCount[i];
    if (!nsc_rle_decode(rle, rleSize, context->priv->PlaneBuffers[i],
                        context->priv->PlaneBuffersLength, originalSize))
      return FALSE;
		
		rle += planeSize;
	}

	return TRUE;
}

BOOL nsc_rle_decode(const BYTE* in, size_t inSize, BYTE* out, UINT32 outSize,
                           UINT32 originalSize)
{
        UINT32 left = originalSize;
 
        while (left > 4)
        {
                if (inSize < 1)
                        return FALSE;
                inSize--;
 
                const BYTE value = *in++;
                UINT32 len = 0;
 
                if (left == 5)
                {
                        if (outSize < 1)
                                return FALSE;
 
                        outSize--;
                        *out++ = value;
                        left--;
                }
              else if (inSize < 1)
                        return FALSE;
                else if (value == *in)
                {
                        inSize--;
                        in++;
 
                        if (inSize < 1)
                                return FALSE;
                        else if (*in < 0xFF)
                        {
                                inSize--;
                                len = (UINT32)*in++;
                                len += 2;
                        }
                        else
                        {
                                if (inSize < 5)
                                        return FALSE;
                                inSize -= 5;
                                in++;
                                len = ((UINT32)(*in++));
                                len |= ((UINT32)(*in++)) << 8U;
                                len |= ((UINT32)(*in++)) << 16U;
                                len |= ((UINT32)(*in++)) << 24U;
                        }
                        if (outSize < len)
                                return FALSE;
                        // if (left < len)
				                //         return FALSE;
                        out += len;
                        left -= len;
                }
                else
                {
                        if (outSize < 1)
                                return FALSE;

                        outSize--;
                        *out++ = value;
                        left--;
                }
        }

}

int main(int argc, char **argv) {

  NSC_CONTEXT context;
  init_nsc_context(&context, argv[1]);
  nsc_rle_decompress_data(&context);
  return 0;
}