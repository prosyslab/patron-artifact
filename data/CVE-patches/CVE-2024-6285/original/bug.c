#include <stdio.h>
#include <stdint.h>

#define IO_SUCCESS		(0)
#define IO_FAIL			(-0x81)
#define IO_NOT_SUPPORTED	(-0x82)
#define IO_RESOURCES_EXHAUSTED	(-0x83)

uintptr_t DRAM1_BASE, DRAM1_SIZE, DRAM_PROTECTED_BASE, DRAM_PROTECTED_SIZE;

void read_dram_info()
{
  FILE *fp;
  fp = fopen("dram_info.txt", "r");
  if (fp == NULL) {
    printf("Error opening file\n");
    return;
  }
  fscanf(fp, "%lx %lx %lx %lx", &DRAM1_BASE, &DRAM1_SIZE, &DRAM_PROTECTED_BASE, &DRAM_PROTECTED_SIZE);
}

void init_params(uintptr_t *dst, uintptr_t *len) {
  *dst = 0x1000;
  *len = 0x1000;
  FILE *fp;
  fp = fopen("params.txt", "r");
  if (fp == NULL) {
    printf("Error opening file\n");
    return;
  }
  fscanf(fp, "%lx %lx", dst, len);

}

static int32_t check_load_area(uintptr_t dst, uintptr_t len)
{
	uint32_t legacy = dst + len <= UINT32_MAX - 1 ? 1 : 0;
	uintptr_t dram_start, dram_end;
	uintptr_t prot_start, prot_end;
	int32_t result = IO_SUCCESS;
	dram_start = legacy ? DRAM1_BASE : DRAM_40BIT_BASE;
	dram_end = legacy ? DRAM1_BASE + DRAM1_SIZE :
	    DRAM_40BIT_BASE + DRAM_40BIT_SIZE;
	prot_start = legacy ? DRAM_PROTECTED_BASE : DRAM_40BIT_PROTECTED_BASE;

	prot_end = prot_start + DRAM_PROTECTED_SIZE;

	if (dst < dram_start || dst > dram_end - len) {
	// if (dst < dram_start || dst > dram_end - len || dram_end < len) {
		ERROR("BL2: dst address is on the protected area.\n");
    ERROR("BL2: Out of range : dst=0x%lx len=0x%lx\n", dst, len);
		return IO_FAIL;
	}
	/* load image is within SDRAM protected area */
	if (dst >= prot_start && dst < prot_end) {
		ERROR("BL2: dst address is on the protected area.\n");
    ERROR("BL2: Out of range : dst=0x%lx len=0x%lx\n", dst, len);
		return IO_FAIL;
	}

	if (dst < prot_start && dst > prot_start - len) {
	// if ((dst < prot_start && dst > prot_start - len) || prot_start < len) {
		ERROR("BL2: loaded data is on the protected area.\n");
    ERROR("BL2: Out of range : dst=0x%lx len=0x%lx\n", dst, len);
		return IO_FAIL;
	}
	return result;
}

int main(int argc, char **argv) {
  uintptr_t dst = 0x1000;
  uintptr_t len = 0x1000;
  init_params(&dst, &len);
  read_dram_info();
  check_load_area(dst, len);
  return 0;
}