#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#define GFX_PIXEL_FORMAT_ARGB_8888 0x00
#define GFX_PIXEL_FORMAT_XRGB_8888 0x01
#define PIXEL_FORMAT_BGRA32 0x02
#define PIXEL_FORMAT_BGRX32 0x03
#define ERROR_INTERNAL_ERROR 0x04

typedef unsigned char BYTE;

typedef struct _RDPGFX_CREATE_SURFACE_PDU
{
  uint32_t surfaceId;
  uint32_t width;
  uint32_t height;
  uint32_t pixelFormat;
} RDPGFX_CREATE_SURFACE_PDU;

typedef struct _gdiGfxSurface
{
  uint32_t surfaceId;
  uint32_t width;
  uint32_t height;
  uint32_t mappedWidth;
  uint32_t mappedHeight;
  uint32_t outputTargetWidth;
  uint32_t outputTargetHeight;
  uint32_t format;
  uint32_t scanline;
  BYTE* data;
} gdiGfxSurface;

void init_source(RDPGFX_CREATE_SURFACE_PDU *createSurface) {
  FILE *fp = fopen("dummy.c", "rb");
  if (fp == NULL) {
    printf("Error opening file\n");
    return;
  }
  fread(&createSurface->surfaceId, sizeof(uint32_t), 1, fp);
  fread(&createSurface->width, sizeof(uint32_t), 1, fp);
  fread(&createSurface->height, sizeof(uint32_t), 1, fp);
  fread(&createSurface->pixelFormat, sizeof(uint32_t), 1, fp);
  fclose(fp);
}

uint32_t gfx_align_scanline(uint32_t scanline, uint32_t alignment) {
  return (scanline + (alignment - 1)) & ~(alignment - 1);
}
/**
 * Function description
 *
 * @return 0 on success, otherwise a Win32 error code
 */
static uint64_t gdi_CreateSurface(const RDPGFX_CREATE_SURFACE_PDU* createSurface)
{
	uint64_t rc = ERROR_INTERNAL_ERROR;
	gdiGfxSurface* surface;
	surface = (gdiGfxSurface*)calloc(1, sizeof(gdiGfxSurface));

	if (!surface)
		return -1;

	surface->surfaceId = createSurface->surfaceId;
	surface->width = gfx_align_scanline(createSurface->width, 16);
	surface->height = gfx_align_scanline(createSurface->height, 16);
	surface->mappedWidth = createSurface->width;
	surface->mappedHeight = createSurface->height;
	surface->outputTargetWidth = createSurface->width;
	surface->outputTargetHeight = createSurface->height;

	switch (createSurface->pixelFormat)
	{
		case GFX_PIXEL_FORMAT_ARGB_8888:
			surface->format = PIXEL_FORMAT_BGRA32;
			break;

		case GFX_PIXEL_FORMAT_XRGB_8888:
			surface->format = PIXEL_FORMAT_BGRX32;
			break;

		default:
			free(surface);
			return -1;
	}

	surface->scanline = gfx_align_scanline(surface->width * 4UL, 16);
	surface->data = (BYTE*)winpr_aligned_malloc(surface->scanline * surface->height * 1ULL, 16); // IO
  // surface->data = (BYTE*)winpr_aligned_malloc((size_t)surface->scanline * surface->height, 16); 
	if (!surface->data)
	{
		free(surface);
		return -1;
	}

	memset(surface->data, 0xFF, (size_t)surface->scanline * surface->height); // BO
  return 0;

}


int main(int argc, char **argv) {
  RDPGFX_CREATE_SURFACE_PDU createSurface;
  init_source(&createSurface);
  gdi_CreateSurface(&createSurface);
  return 0;
}