#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

/*******************************************************************/
/* reads 'count' bytes from a socket  */
/********************************************************************/


int MyNread(int fd, char *buf, size_t count)
{
    size_t r;
    size_t nleft = count;

    while (nleft > 0) {
        r = read(fd, buf, nleft);
        if (r < 0) {
              return -1;
        } else if (r == 0)
            break;

        nleft -= r;
        buf += r;
    }
    return count - nleft;
}

void JSON_read(int fd)
{
    uint32_t hsize, nsize;
    size_t strsize;
    char *str;
    int rc;
    /*
     * Read a four-byte integer, which is the length of the JSON to follow.
     * Then read the JSON into a buffer and parse it.  Return a parsed JSON
     * structure, NULL if there was an error.
     */
    if (MyNread(fd, (char*) &nsize, sizeof(nsize)) >= 0) {
	    hsize = ntohl(nsize);
	/* Allocate a buffer to hold the JSON */
	str = (char *) calloc(sizeof(char), hsize+1);	/* +1 for trailing null */
	// strsize = hsize + 1;              /* +1 for trailing NULL */
	// if (strsize) {
	// str = (char *) calloc(sizeof(char), strsize);
  if (str != NULL) {
	    rc = MyNread(fd, str, hsize);
	}
	free(str);
	}
	else {
	    printf("WARNING:  Data length overflow\n");
	}
    // }
    return;
    
}

int main(int argc, char **argv) {
  FILE *fp = fopen("dummy.c", "r");
  JSON_read(fileno(fp));
  
  return 0;
}