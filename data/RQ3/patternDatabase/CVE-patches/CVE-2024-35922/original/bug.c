#include <stdio.h>
#include <stdint.h>

struct videomode {
	unsigned long pixelclock;	/* pixelclock in Hz */

	uint_32_t hactive;
	uint_32_t hfront_porch;
	uint_32_t hback_porch;
	uint_32_t hsync_len;

	uint_32_t vactive;
	uint_32_t vfront_porch;
	uint_32_t vback_porch;
	uint_32_t vsync_len;

};

void of_get_videomode(struct videomode *vm)
{
  FILE *fp;
  fp = fopen("linux.c", "r");
  // simplified source
  fscanf(fp, "%lu", &vm->pixelclock);
  fscanf(fp, "%d", &vm->hactive);
  fscanf(fp, "%d", &vm->hfront_porch);
  fscanf(fp, "%d", &vm->hback_porch);
  fscanf(fp, "%d", &vm->hsync_len);
  fscanf(fp, "%d", &vm->vactive);
  fscanf(fp, "%d", &vm->vfront_porch);
  fscanf(fp, "%d", &vm->vback_porch);
  fscanf(fp, "%d", &vm->vsync_len);

  return;
}

// sliced from drivers/video/fbdev/core/fbmon.c:fb_videomode_from_videomode
int main(int argc, char **argv) {
  unsigned int htotal, vtotal, total;
  uint_32_t refresh;
  struct videomode vm;

  of_get_videomode(&vm);
	
  htotal = vm.hactive + vm.hfront_porch + vm.hback_porch +
		 vm.hsync_len;
	vtotal = vm.vactive + vm.vfront_porch + vm.vback_porch +
		 vm.vsync_len;

  if (htotal && vtotal) {
    // sink
		refresh = vm.pixelclock / (htotal * vtotal);
  }
  return 0;
}