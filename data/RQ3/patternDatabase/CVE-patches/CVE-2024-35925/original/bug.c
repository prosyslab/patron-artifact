#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>

struct blk_rq_stat {
	uint_64_t mean;
	uint_64_t min;
	uint_64_t max;
	uint_32_t nr_samples;
	uint_64_t batch;
};

// void blk_rq_stat_init(struct blk_rq_stat *stat) {
// 	stat->min = -1ULL;
// 	stat->max = stat->nr_samples = stat->mean = 0;
// 	stat->batch = 0;
// }

void blk_rq_stat_init(struct blk_rq_stat *stat) {
  stat->min = -1ULL;
  stat->max = stat->mean = 0;
  FILE *fp;
  fp = fopen("linux.c", "r");
  // simplified source
  fscanf(fp, "%d", &stat->nr_samples);
  return;
}

void blk_rq_stat_sum (struct blk_rq_stat *dst, struct blk_rq_stat *src) {
  FILE *fp;

  dst = (struct blk_rq_stat *)malloc(sizeof(struct blk_rq_stat));
  src = (struct blk_rq_stat *)malloc(sizeof(struct blk_rq_stat));

  src->min = -1ULL;
  src->max = src->mean = 0;
  src->batch = 0;
  dst->min = -1ULL;
  dst->max = dst->mean = 0;
  dst->batch = 0;
  
  fp = fopen("linux.c", "r");

  fscanf(fp, "%d", &dst->nr_samples);
  fscanf(fp, "%d", &src->nr_samples);

  if (!src->nr_samples)
    return;
  // dst->min = dst->min < src->min ? dst->min : src->min;
  // dst->max = dst->max > src->max ? dst->max : src->max;

  dst->mean = (src->batch + dst->mean * dst->nr_samples) /
        (dst->nr_samples + src->nr_samples);

  free(dst);
  free(src);

}

// sliced from block/blk-stat.c
int main(int argc, char **argv) {
  
  struct blk_rq_stat *dst, *src;

  blk_rq_stat_sum(dst, src);

  return 0; 
}